{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{{ t.ml_analysis }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshBtn">
                <i class="fas fa-sync-alt"></i> {{ t.refresh }}
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" id="autoRefreshBtn" data-active="true">
                <i class="fas fa-pause"></i> {{ t.auto_refresh }}
            </button>
        </div>
    </div>
</div>

<!-- Status Indicator -->
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-info d-flex align-items-center" role="alert" id="statusIndicator">
            <i class="fas fa-info-circle me-2"></i>
            <div id="statusMessage">{{ t.loading_ml_data }}</div>
        </div>
    </div>
</div>

<!-- Anomaly Detection Results -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">{{ t.anomaly_detection }}</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>{{ t.method }}</th>
                                <th>{{ t.total_anomalies }}</th>
                                <th>{{ t.anomaly_percentage }}</th>
                                <th>{{ t.last_updated }}</th>
                            </tr>
                        </thead>
                        <tbody id="anomalyDetectionTableBody">
                            <tr>
                                <td colspan="4" class="text-center">{{ t.loading_ml_data }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Forecasting -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">{{ t.performance_forecasting }}</h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="forecastTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="download-tab" data-bs-toggle="tab" data-bs-target="#download" type="button" role="tab">{{ t.download_speed }}</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab">{{ t.upload_speed }}</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ping-tab" data-bs-toggle="tab" data-bs-target="#ping" type="button" role="tab">{{ t.ping }}</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="packetloss-tab" data-bs-toggle="tab" data-bs-target="#packetloss" type="button" role="tab">{{ t.packet_loss }}</button>
                    </li>
                </ul>
                <div class="tab-content" id="forecastTabContent">
                    <div class="tab-pane fade show active" id="download" role="tabpanel">
                        <canvas id="downloadForecastChart" height="300"></canvas>
                    </div>
                    <div class="tab-pane fade" id="upload" role="tabpanel">
                        <canvas id="uploadForecastChart" height="300"></canvas>
                    </div>
                    <div class="tab-pane fade" id="ping" role="tabpanel">
                        <canvas id="pingForecastChart" height="300"></canvas>
                    </div>
                    <div class="tab-pane fade" id="packetloss" role="tabpanel">
                        <canvas id="packetlossForecastChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Anomaly Results -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">{{ t.detailed_anomaly_results }}</h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="anomalyTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="isolation-forest-tab" data-bs-toggle="tab" data-bs-target="#isolation-forest" type="button" role="tab">{{ t.isolation_forest }}</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="dbscan-tab" data-bs-toggle="tab" data-bs-target="#dbscan" type="button" role="tab">{{ t.dbscan }}</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="elliptic-envelope-tab" data-bs-toggle="tab" data-bs-target="#elliptic-envelope" type="button" role="tab">{{ t.elliptic_envelope }}</button>
                    </li>
                </ul>
                <div class="tab-content" id="anomalyTabContent">
                    <div class="tab-pane fade show active" id="isolation-forest" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>{{ t.timestamp }}</th>
                                        <th>{{ t.download_speed }} (Mbps)</th>
                                        <th>{{ t.upload_speed }} (Mbps)</th>
                                        <th>{{ t.ping }} (ms)</th>
                                        <th>{{ t.packet_loss }} (%)</th>
                                        <th>{{ t.anomaly_detection }}</th>
                                    </tr>
                                </thead>
                                <tbody id="isolationForestAnomaliesTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center">{{ t.loading_ml_data }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="dbscan" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>{{ t.timestamp }}</th>
                                        <th>{{ t.download_speed }} (Mbps)</th>
                                        <th>{{ t.upload_speed }} (Mbps)</th>
                                        <th>{{ t.ping }} (ms)</th>
                                        <th>{{ t.packet_loss }} (%)</th>
                                    </tr>
                                </thead>
                                <tbody id="dbscanAnomaliesTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center">{{ t.loading_ml_data }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="elliptic-envelope" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>{{ t.timestamp }}</th>
                                        <th>{{ t.download_speed }} (Mbps)</th>
                                        <th>{{ t.upload_speed }} (Mbps)</th>
                                        <th>{{ t.ping }} (ms)</th>
                                        <th>{{ t.packet_loss }} (%)</th>
                                    </tr>
                                </thead>
                                <tbody id="ellipticEnvelopeAnomaliesTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center">{{ t.loading_ml_data }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Global variables
    let autoRefreshInterval = null;
    let mlAnalysisData = null;
    let forecastCharts = {};

    // Update status indicator
    function updateStatus(message, type = 'info') {
        const statusIndicator = document.getElementById('statusIndicator');
        const statusMessage = document.getElementById('statusMessage');
        
        // Remove existing classes
        statusIndicator.className = 'alert d-flex align-items-center';
        
        // Add appropriate class based on type
        switch(type) {
            case 'success':
                statusIndicator.classList.add('alert-success');
                statusIndicator.innerHTML = '<i class="fas fa-check-circle me-2"></i><div id="statusMessage">' + message + '</div>';
                break;
            case 'warning':
                statusIndicator.classList.add('alert-warning');
                statusIndicator.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i><div id="statusMessage">' + message + '</div>';
                break;
            case 'danger':
                statusIndicator.classList.add('alert-danger');
                statusIndicator.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i><div id="statusMessage">' + message + '</div>';
                break;
            default:
                statusIndicator.classList.add('alert-info');
                statusIndicator.innerHTML = '<i class="fas fa-info-circle me-2"></i><div id="statusMessage">' + message + '</div>';
        }
    }

    // Update anomaly detection table
    function updateAnomalyDetectionTable() {
        const tableBody = document.getElementById('anomalyDetectionTableBody');
        
        if (!mlAnalysisData || !mlAnalysisData.summary || !mlAnalysisData.summary.anomaly_detection) {
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center">{{ t.no_anomaly_data_available }}</td></tr>';
            return;
        }
        
        const anomalyData = mlAnalysisData.summary.anomaly_detection;
        tableBody.innerHTML = '';
        
        for (const [method, data] of Object.entries(anomalyData)) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${method.replace('_', ' ')}</td>
                <td>${data.total_anomalies}</td>
                <td>${data.anomaly_percentage.toFixed(2)}%</td>
                <td>${new Date(mlAnalysisData.generated_at).toLocaleString()}</td>
            `;
            tableBody.appendChild(row);
        }
    }

    // Update anomaly details tables
    function updateAnomalyDetails() {
        if (!mlAnalysisData || !mlAnalysisData.full_analysis || !mlAnalysisData.full_analysis.anomaly_detection) {
            document.getElementById('isolationForestAnomaliesTableBody').innerHTML = '<tr><td colspan="6" class="text-center">{{ t.no_anomaly_data_available }}</td></tr>';
            document.getElementById('dbscanAnomaliesTableBody').innerHTML = '<tr><td colspan="5" class="text-center">{{ t.no_anomaly_data_available }}</td></tr>';
            document.getElementById('ellipticEnvelopeAnomaliesTableBody').innerHTML = '<tr><td colspan="5" class="text-center">{{ t.no_anomaly_data_available }}</td></tr>';
            return;
        }
        
        const anomalyData = mlAnalysisData.full_analysis.anomaly_detection.methods;
        
        // Update Isolation Forest anomalies
        const isoForestBody = document.getElementById('isolationForestAnomaliesTableBody');
        if (anomalyData.isolation_forest && anomalyData.isolation_forest.anomalies) {
            isoForestBody.innerHTML = '';
            anomalyData.isolation_forest.anomalies.forEach(anomaly => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(anomaly.timestamp).toLocaleString()}</td>
                    <td>${anomaly.download_mbps.toFixed(2)}</td>
                    <td>${anomaly.upload_mbps.toFixed(2)}</td>
                    <td>${anomaly.ping_ms.toFixed(2)}</td>
                    <td>${anomaly.packet_loss_percent.toFixed(2)}</td>
                    <td>${anomaly.anomaly_score.toFixed(4)}</td>
                `;
                isoForestBody.appendChild(row);
            });
        } else {
            isoForestBody.innerHTML = '<tr><td colspan="6" class="text-center">{{ t.no_anomalies_detected }}</td></tr>';
        }
        
        // Update DBSCAN anomalies
        const dbscanBody = document.getElementById('dbscanAnomaliesTableBody');
        if (anomalyData.dbscan && anomalyData.dbscan.anomalies) {
            dbscanBody.innerHTML = '';
            anomalyData.dbscan.anomalies.forEach(anomaly => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(anomaly.timestamp).toLocaleString()}</td>
                    <td>${anomaly.download_mbps.toFixed(2)}</td>
                    <td>${anomaly.upload_mbps.toFixed(2)}</td>
                    <td>${anomaly.ping_ms.toFixed(2)}</td>
                    <td>${anomaly.packet_loss_percent.toFixed(2)}</td>
                `;
                dbscanBody.appendChild(row);
            });
        } else {
            dbscanBody.innerHTML = '<tr><td colspan="5" class="text-center">{{ t.no_anomalies_detected }}</td></tr>';
        }
        
        // Update Elliptic Envelope anomalies
        const ellipticBody = document.getElementById('ellipticEnvelopeAnomaliesTableBody');
        if (anomalyData.elliptic_envelope && anomalyData.elliptic_envelope.anomalies) {
            ellipticBody.innerHTML = '';
            anomalyData.elliptic_envelope.anomalies.forEach(anomaly => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(anomaly.timestamp).toLocaleString()}</td>
                    <td>${anomaly.download_mbps.toFixed(2)}</td>
                    <td>${anomaly.upload_mbps.toFixed(2)}</td>
                    <td>${anomaly.ping_ms.toFixed(2)}</td>
                    <td>${anomaly.packet_loss_percent.toFixed(2)}</td>
                `;
                ellipticBody.appendChild(row);
            });
        } else {
            ellipticBody.innerHTML = '<tr><td colspan="5" class="text-center">{{ t.no_anomalies_detected }}</td></tr>';
        }
    }

    // Create or update forecast chart
    function updateForecastChart(metric, chartId) {
        if (!mlAnalysisData || !mlAnalysisData.full_analysis || !mlAnalysisData.full_analysis.performance_forecasting) {
            return;
        }
        
        const forecastData = mlAnalysisData.full_analysis.performance_forecasting.forecasts;
        
        if (!forecastData[metric]) {
            return;
        }
        
        // Get forecast data (use ARIMA as primary method)
        let forecasts = [];
        let confidenceLower = [];
        let confidenceUpper = [];
        
        if (forecastData[metric].arima && forecastData[metric].arima.forecasts) {
            forecasts = forecastData[metric].arima.forecasts;
            if (forecastData[metric].arima.confidence_intervals) {
                confidenceLower = forecastData[metric].arima.confidence_intervals.lower;
                confidenceUpper = forecastData[metric].arima.confidence_intervals.upper;
            }
        }
        
        if (forecasts.length === 0) {
            return;
        }
        
        // Generate future dates
        const startDate = new Date();
        const dates = [];
        for (let i = 1; i <= forecasts.length; i++) {
            const date = new Date(startDate);
            date.setDate(date.getDate() + i);
            dates.push(date.toLocaleDateString());
        }
        
        // Destroy existing chart if it exists
        if (forecastCharts[chartId]) {
            forecastCharts[chartId].destroy();
        }
        
        // Create new chart
        const ctx = document.getElementById(chartId).getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: `${metric.replace('_', ' ')} Forecast`,
                    data: forecasts,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    fill: false,
                    tension: 0.1
                }, {
                    label: 'Lower Confidence',
                    data: confidenceLower,
                    borderColor: 'rgba(255, 99, 132, 0.5)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    fill: '+1',
                    borderDash: [5, 5],
                    pointRadius: 0
                }, {
                    label: 'Upper Confidence',
                    data: confidenceUpper,
                    borderColor: 'rgba(255, 99, 132, 0.5)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    fill: false,
                    borderDash: [5, 5],
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });
        
        forecastCharts[chartId] = chart;
    }

    // Update all forecast charts
    function updateForecastCharts() {
        updateForecastChart('download_mbps', 'downloadForecastChart');
        updateForecastChart('upload_mbps', 'uploadForecastChart');
        updateForecastChart('ping_ms', 'pingForecastChart');
        updateForecastChart('packet_loss_percent', 'packetlossForecastChart');
    }

    // Fetch ML analysis data
    async function fetchMLAnalysis() {
        try {
            updateStatus('{{ t.loading_ml_data }}', 'info');
            const response = await axios.get('/api/ml-analysis');
            mlAnalysisData = response.data;
            
            if (mlAnalysisData) {
                updateAnomalyDetectionTable();
                updateAnomalyDetails();
                updateForecastCharts();
                updateStatus('{{ t.ml_loaded_success }}', 'success');
            } else {
                updateStatus('{{ t.ml_no_data }}', 'warning');
            }
        } catch (error) {
            console.error('Error fetching ML analysis data:', error);
            updateStatus('{{ t.ml_error }}', 'danger');
        }
    }

    // Toggle auto refresh
    function toggleAutoRefresh() {
        const btn = document.getElementById('autoRefreshBtn');
        const isActive = btn.getAttribute('data-active') === 'true';
        
        if (isActive) {
            // Disable auto refresh
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            btn.innerHTML = '<i class="fas fa-play"></i> Auto Refresh';
            btn.setAttribute('data-active', 'false');
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-outline-secondary');
        } else {
            // Enable auto refresh
            autoRefreshInterval = setInterval(() => {
                fetchMLAnalysis();
            }, 60000); // Refresh every minute
            btn.innerHTML = '<i class="fas fa-pause"></i> Auto Refresh';
            btn.setAttribute('data-active', 'true');
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-outline-primary');
        }
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        // Initial data load
        fetchMLAnalysis();
        
        // Set up refresh button
        document.getElementById('refreshBtn').addEventListener('click', function() {
            fetchMLAnalysis();
        });
        
        // Set up auto refresh button
        document.getElementById('autoRefreshBtn').addEventListener('click', function() {
            toggleAutoRefresh();
        });
        
        // Start auto refresh
        autoRefreshInterval = setInterval(() => {
            fetchMLAnalysis();
        }, 60000); // Refresh every minute
    });
</script>
{% endblock %}