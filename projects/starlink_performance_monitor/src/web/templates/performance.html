{% extends "base.html" %}

{% block title %}Performance History - Starlink Monitor{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
    <h1 class="h2 page-heading">Performance History</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="timeRangeBtn" data-range="24h">
                <i class="fas fa-clock"></i> Last 24 Hours
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" data-range="7d">
                Last 7 Days
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" data-range="30d">
                Last 30 Days
            </button>
        </div>
        <div class="dropdown me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="fas fa-download"></i> Export
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" id="exportCSV">CSV</a></li>
                <li><a class="dropdown-item" href="#" id="exportJSON">JSON</a></li>
                <li><a class="dropdown-item" href="#" id="exportPDF">PDF</a></li>
                <li><a class="dropdown-item" href="#" id="exportExcel">Excel</a></li>
            </ul>
        </div>
        <button type="button" class="btn btn-sm btn-outline-primary" id="comparePeriods">
            <i class="fas fa-balance-scale"></i> Compare
        </button>
    </div>
</div>

<!-- Advanced Filters -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0 d-flex justify-content-between align-items-center">
                    <span>Advanced Filters</span>
                    <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="true" aria-controls="filterCollapse">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                </h5>
            </div>
            <div class="collapse show" id="filterCollapse">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="metricType" class="form-label fw-bold">Metric Type</label>
                            <select class="form-select" id="metricType">
                                <option value="all">All Metrics</option>
                                <option value="download">Download Speed</option>
                                <option value="upload">Upload Speed</option>
                                <option value="ping">Ping</option>
                                <option value="packetloss">Packet Loss</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="serverFilter" class="form-label fw-bold">Server</label>
                            <select class="form-select" id="serverFilter">
                                <option value="all">All Servers</option>
                                <option value="starlink">Starlink</option>
                                <option value="google">Google DNS</option>
                                <option value="cloudflare">Cloudflare</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="dateRange" class="form-label fw-bold">Date Range</label>
                            <input type="text" class="form-control" id="dateRange" placeholder="Select date range">
                        </div>
                        <div class="col-md-3">
                            <label for="performanceThreshold" class="form-label fw-bold">Performance Threshold</label>
                            <select class="form-select" id="performanceThreshold">
                                <option value="all">All Data</option>
                                <option value="poor">Poor Performance (&lt; 25th percentile)</option>
                                <option value="good">Good Performance (&gt; 75th percentile)</option>
                                <option value="outlier">Outliers (&gt; 95th percentile)</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-3">
                            <label for="minDownload" class="form-label">Min Download (Mbps)</label>
                            <input type="number" class="form-control" id="minDownload" placeholder="0">
                        </div>
                        <div class="col-md-3">
                            <label for="maxPing" class="form-label">Max Ping (ms)</label>
                            <input type="number" class="form-control" id="maxPing" placeholder="1000">
                        </div>
                        <div class="col-md-3">
                            <label for="maxPacketLoss" class="form-label">Max Packet Loss (%)</label>
                            <input type="number" class="form-control" id="maxPacketLoss" placeholder="100" step="0.1">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-primary w-100" id="applyFilters">
                                <i class="fas fa-filter"></i> Apply Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Performance Trends</h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary" id="chartTypeLine">Line</button>
                    <button type="button" class="btn btn-outline-primary" id="chartTypeBar">Bar</button>
                    <button type="button" class="btn btn-outline-primary" id="chartTypeArea">Area</button>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Statistical Summary</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Min</th>
                                <th>Avg</th>
                                <th>Max</th>
                                <th>Std Dev</th>
                                <th>95th %</th>
                            </tr>
                        </thead>
                        <tbody id="statsTable">
                            <tr>
                                <td>Download (Mbps)</td>
                                <td id="downloadMin">--</td>
                                <td id="downloadAvg">--</td>
                                <td id="downloadMax">--</td>
                                <td id="downloadStd">--</td>
                                <td id="download95">--</td>
                            </tr>
                            <tr>
                                <td>Upload (Mbps)</td>
                                <td id="uploadMin">--</td>
                                <td id="uploadAvg">--</td>
                                <td id="uploadMax">--</td>
                                <td id="uploadStd">--</td>
                                <td id="upload95">--</td>
                            </tr>
                            <tr>
                                <td>Ping (ms)</td>
                                <td id="pingMin">--</td>
                                <td id="pingAvg">--</td>
                                <td id="pingMax">--</td>
                                <td id="pingStd">--</td>
                                <td id="ping95">--</td>
                            </tr>
                            <tr>
                                <td>Packet Loss (%)</td>
                                <td id="packetLossMin">--</td>
                                <td id="packetLossAvg">--</td>
                                <td id="packetLossMax">--</td>
                                <td id="packetLossStd">--</td>
                                <td id="packetLoss95">--</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Performance Distribution</h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Raw Data</h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary" id="prevPage">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="nextPage">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="dataTable">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Download (Mbps)</th>
                                <th>Upload (Mbps)</th>
                                <th>Ping (ms)</th>
                                <th>Packet Loss (%)</th>
                                <th>Server</th>
                                <th>Performance Index</th>
                            </tr>
                        </thead>
                        <tbody id="dataBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        Showing <span id="startRow">0</span> to <span id="endRow">0</span> of <span id="totalRows">0</span> entries
                    </div>
                    <div>
                        <select class="form-select form-select-sm d-inline-block w-auto" id="rowsPerPage">
                            <option value="10">10 rows</option>
                            <option value="25" selected>25 rows</option>
                            <option value="50">50 rows</option>
                            <option value="100">100 rows</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Comparison Modal -->
<div class="modal fade" id="compareModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Performance Comparison</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Period 1</h6>
                        <div class="mb-3">
                            <label class="form-label">Date Range</label>
                            <input type="text" class="form-control" id="period1Range" placeholder="Select date range">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Period 2</h6>
                        <div class="mb-3">
                            <label class="form-label">Date Range</label>
                            <input type="text" class="form-control" id="period2Range" placeholder="Select date range">
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <canvas id="comparisonChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="runComparison">Compare</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize performance page
    document.addEventListener('DOMContentLoaded', function() {
        // Set up time range buttons
        document.querySelectorAll('[data-range]').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('[data-range]').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                document.getElementById('timeRangeBtn').innerHTML = 
                    `<i class="fas fa-clock"></i> Last ${this.dataset.range}`;
                loadData(this.dataset.range);
            });
        });
        
        // Set up export buttons
        document.getElementById('exportCSV').addEventListener('click', function() {
            exportData('csv');
        });
        
        document.getElementById('exportJSON').addEventListener('click', function() {
            exportData('json');
        });
        
        document.getElementById('exportPDF').addEventListener('click', function() {
            exportData('pdf');
        });
        
        document.getElementById('exportExcel').addEventListener('click', function() {
            exportData('excel');
        });
        
        // Set up filter button
        document.getElementById('applyFilters').addEventListener('click', function() {
            applyFilters();
        });
        
        // Set up comparison button
        document.getElementById('comparePeriods').addEventListener('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('compareModal'));
            modal.show();
        });
        
        // Set up chart type buttons
        document.getElementById('chartTypeLine').addEventListener('click', function() {
            updateChartType('line');
        });
        
        document.getElementById('chartTypeBar').addEventListener('click', function() {
            updateChartType('bar');
        });
        
        document.getElementById('chartTypeArea').addEventListener('click', function() {
            updateChartType('area');
        });
        
        // Set up pagination
        document.getElementById('prevPage').addEventListener('click', function() {
            changePage(-1);
        });
        
        document.getElementById('nextPage').addEventListener('click', function() {
            changePage(1);
        });
        
        document.getElementById('rowsPerPage').addEventListener('change', function() {
            currentPage = 1;
            displayTableData();
        });
        
        // Set up comparison button
        document.getElementById('runComparison').addEventListener('click', function() {
            runComparison();
        });
        
        // Load initial data
        loadData('24h');
    });
    
    // Global variables
    let currentData = [];
    let filteredData = [];
    let currentPage = 1;
    let rowsPerPage = 25;
    let currentChartType = 'line';
    let trendChart = null;
    let distributionChart = null;
    let comparisonChart = null;
    
    async function loadData(timeRange) {
        try {
            const hours = timeRange === '24h' ? 24 : 
                         timeRange === '7d' ? 168 : 
                         timeRange === '30d' ? 720 : 24;
            
            const response = await axios.get(`/api/metrics?hours=${hours}`);
            const data = response.data.data;
            
            if (data && data.length > 0) {
                currentData = data;
                filteredData = [...data];
                updateCharts(data);
                updateStats(data);
                displayTableData();
            }
        } catch (error) {
            console.error('Error loading data:', error);
        }
    }
    
    function updateCharts(data) {
        // Update trend chart
        const ctx1 = document.getElementById('trendChart').getContext('2d');
        
        // Convert data for Chart.js
        const timestamps = data.map(item => new Date(item.timestamp).toLocaleDateString());
        const downloadSpeeds = data.map(item => item.download_mbps);
        const uploadSpeeds = data.map(item => item.upload_mbps);
        const pingTimes = data.map(item => item.ping_ms);
        const packetLoss = data.map(item => item.packet_loss_percent);
        
        // Clear existing chart if it exists
        if (trendChart) {
            trendChart.destroy();
        }
        
        // Create new chart
        const chartConfig = {
            type: currentChartType === 'bar' ? 'bar' : currentChartType === 'area' ? 'line' : 'line',
            data: {
                labels: timestamps,
                datasets: [{
                    label: 'Download Speed (Mbps)',
                    data: downloadSpeeds,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: currentChartType === 'area' ? 'rgba(54, 162, 235, 0.2)' : 'transparent',
                    tension: 0.1,
                    fill: currentChartType === 'area'
                }, {
                    label: 'Upload Speed (Mbps)',
                    data: uploadSpeeds,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: currentChartType === 'area' ? 'rgba(75, 192, 192, 0.2)' : 'transparent',
                    tension: 0.1,
                    fill: currentChartType === 'area'
                }, {
                    label: 'Ping (ms)',
                    data: pingTimes,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: currentChartType === 'area' ? 'rgba(255, 99, 132, 0.2)' : 'transparent',
                    tension: 0.1,
                    yAxisID: 'y1',
                    fill: currentChartType === 'area'
                }, {
                    label: 'Packet Loss (%)',
                    data: packetLoss,
                    borderColor: 'rgb(255, 159, 64)',
                    backgroundColor: currentChartType === 'area' ? 'rgba(255, 159, 64, 0.2)' : 'transparent',
                    tension: 0.1,
                    yAxisID: 'y2',
                    fill: currentChartType === 'area'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Speed (Mbps)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Ping (ms)'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    },
                    y2: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Packet Loss (%)'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        };
        
        trendChart = new Chart(ctx1, chartConfig);
    }
    
    function updateStats(data) {
        // Calculate statistics for download speed
        const downloadSpeeds = data.map(item => item.download_mbps);
        const uploadSpeeds = data.map(item => item.upload_mbps);
        const pingTimes = data.map(item => item.ping_ms);
        const packetLoss = data.map(item => item.packet_loss_percent);
        
        // Helper function to calculate stats
        function calculateStats(values) {
            const sorted = [...values].sort((a, b) => a - b);
            const min = Math.min(...sorted);
            const max = Math.max(...sorted);
            const avg = sorted.reduce((a, b) => a + b, 0) / sorted.length;
            const std = Math.sqrt(sorted.reduce((sq, n) => sq + Math.pow(n - avg, 2), 0) / sorted.length);
            const p95 = sorted[Math.floor(sorted.length * 0.95)];
            return { min, max, avg, std, p95 };
        }
        
        // Update download stats
        const downloadStats = calculateStats(downloadSpeeds);
        document.getElementById('downloadMin').textContent = downloadStats.min.toFixed(2);
        document.getElementById('downloadAvg').textContent = downloadStats.avg.toFixed(2);
        document.getElementById('downloadMax').textContent = downloadStats.max.toFixed(2);
        document.getElementById('downloadStd').textContent = downloadStats.std.toFixed(2);
        document.getElementById('download95').textContent = downloadStats.p95.toFixed(2);
        
        // Update upload stats
        const uploadStats = calculateStats(uploadSpeeds);
        document.getElementById('uploadMin').textContent = uploadStats.min.toFixed(2);
        document.getElementById('uploadAvg').textContent = uploadStats.avg.toFixed(2);
        document.getElementById('uploadMax').textContent = uploadStats.max.toFixed(2);
        document.getElementById('uploadStd').textContent = uploadStats.std.toFixed(2);
        document.getElementById('upload95').textContent = uploadStats.p95.toFixed(2);
        
        // Update ping stats
        const pingStats = calculateStats(pingTimes);
        document.getElementById('pingMin').textContent = pingStats.min.toFixed(2);
        document.getElementById('pingAvg').textContent = pingStats.avg.toFixed(2);
        document.getElementById('pingMax').textContent = pingStats.max.toFixed(2);
        document.getElementById('pingStd').textContent = pingStats.std.toFixed(2);
        document.getElementById('ping95').textContent = pingStats.p95.toFixed(2);
        
        // Update packet loss stats
        const packetLossStats = calculateStats(packetLoss);
        document.getElementById('packetLossMin').textContent = packetLossStats.min.toFixed(2);
        document.getElementById('packetLossAvg').textContent = packetLossStats.avg.toFixed(2);
        document.getElementById('packetLossMax').textContent = packetLossStats.max.toFixed(2);
        document.getElementById('packetLossStd').textContent = packetLossStats.std.toFixed(2);
        document.getElementById('packetLoss95').textContent = packetLossStats.p95.toFixed(2);
    }
    
    function displayTableData() {
        const tbody = document.getElementById('dataBody');
        tbody.innerHTML = '';
        
        // Calculate pagination
        const totalRows = filteredData.length;
        rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
        const startRow = (currentPage - 1) * rowsPerPage;
        const endRow = Math.min(startRow + rowsPerPage, totalRows);
        
        // Update pagination info
        document.getElementById('startRow').textContent = startRow + 1;
        document.getElementById('endRow').textContent = endRow;
        document.getElementById('totalRows').textContent = totalRows;
        
        // Display data for current page
        const pageData = filteredData.slice(startRow, endRow);
        
        pageData.forEach(item => {
            // Calculate a simple performance index (higher is better)
            const perfIndex = (item.download_mbps / 100) + (item.upload_mbps / 20) - (item.ping_ms / 100) - (item.packet_loss_percent / 5);
            const perfIndexClass = perfIndex > 0.5 ? 'text-success' : perfIndex > 0 ? 'text-warning' : 'text-danger';
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${new Date(item.timestamp).toLocaleString()}</td>
                <td>${item.download_mbps.toFixed(2)}</td>
                <td>${item.upload_mbps.toFixed(2)}</td>
                <td>${item.ping_ms.toFixed(2)}</td>
                <td>${item.packet_loss_percent.toFixed(2)}</td>
                <td>${item.server_name}</td>
                <td class="${perfIndexClass}">${perfIndex.toFixed(2)}</td>
            `;
            tbody.appendChild(row);
        });
    }
    
    function changePage(direction) {
        const totalPages = Math.ceil(filteredData.length / rowsPerPage);
        const newPage = currentPage + direction;
        
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            displayTableData();
        }
    }
    
    function applyFilters() {
        // Get filter values
        const metricType = document.getElementById('metricType').value;
        const serverFilter = document.getElementById('serverFilter').value;
        const minDownload = parseFloat(document.getElementById('minDownload').value) || 0;
        const maxPing = parseFloat(document.getElementById('maxPing').value) || Infinity;
        const maxPacketLoss = parseFloat(document.getElementById('maxPacketLoss').value) || Infinity;
        const threshold = document.getElementById('performanceThreshold').value;
        
        // Apply filters
        filteredData = currentData.filter(item => {
            // Server filter
            if (serverFilter !== 'all' && item.server_name.toLowerCase() !== serverFilter) {
                return false;
            }
            
            // Download speed filter
            if (item.download_mbps < minDownload) {
                return false;
            }
            
            // Ping filter
            if (item.ping_ms > maxPing) {
                return false;
            }
            
            // Packet loss filter
            if (item.packet_loss_percent > maxPacketLoss) {
                return false;
            }
            
            // Threshold filter
            if (threshold !== 'all') {
                // In a real implementation, you would calculate percentiles
                // For now, we'll use simple thresholds
                switch(threshold) {
                    case 'poor':
                        if (item.download_mbps > 50 || item.ping_ms < 50) return false;
                        break;
                    case 'good':
                        if (item.download_mbps < 80 || item.ping_ms > 30) return false;
                        break;
                    case 'outlier':
                        if (item.download_mbps < 150 && item.ping_ms > 20) return false;
                        break;
                }
            }
            
            // Metric type filter
            if (metricType !== 'all') {
                // This would be used for more specific filtering
            }
            
            return true;
        });
        
        // Reset to first page and display
        currentPage = 1;
        displayTableData();
        updateCharts(filteredData);
        updateStats(filteredData);
    }
    
    function updateChartType(type) {
        currentChartType = type;
        
        // Update button states
        document.getElementById('chartTypeLine').classList.remove('active');
        document.getElementById('chartTypeBar').classList.remove('active');
        document.getElementById('chartTypeArea').classList.remove('active');
        
        switch(type) {
            case 'line':
                document.getElementById('chartTypeLine').classList.add('active');
                break;
            case 'bar':
                document.getElementById('chartTypeBar').classList.add('active');
                break;
            case 'area':
                document.getElementById('chartTypeArea').classList.add('active');
                break;
        }
        
        // Update charts
        updateCharts(filteredData);
    }
    
    function exportData(format) {
        // In a real implementation, this would export the data
        alert(`Exporting data as ${format.toUpperCase()}. In a real implementation, this would download the file.`);
    }
    
    function runComparison() {
        // In a real implementation, this would compare two periods
        alert('Comparing periods. In a real implementation, this would show a comparison chart.');
        bootstrap.Modal.getInstance(document.getElementById('compareModal')).hide();
    }
</script>
{% endblock %}